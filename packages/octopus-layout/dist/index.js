class t{ctx;options;constructor(t,e){const i=t.getContext("2d");if(!i)throw new Error("无法获取 Canvas 2D 上下文");this.ctx=i,this.options={defaultFontSize:14,defaultFontFamily:"Arial, sans-serif",defaultLineHeight:1.4,...e}}measureText(t,e={}){const i=e.fontSize||this.options.defaultFontSize,o=e.fontFamily||this.options.defaultFontFamily,n=e.fontWeight||"normal",h=e.lineHeight||this.options.defaultLineHeight;this.ctx.font=`${n} ${i}px ${o}`;return{width:this.ctx.measureText(t).width+(e.letterSpacing||0)*(t.length-1),height:i*h}}calculateBoxSize(t){const e=t.box||{},i=e.padding||{},o=e.margin||{},n=e.border||{},h=(i.left||0)+(i.right||0),s=(i.top||0)+(i.bottom||0),r=(o.left||0)+(o.right||0),d=(o.top||0)+(o.bottom||0),c=2*(n.width||0),l=2*(n.width||0);let x=0,a=0;if("text"===t.type&&t.content){const e=this.measureText(t.content,t.style);x=e.width,a=e.height}return void 0!==e.width&&(x=e.width),void 0!==e.height&&(a=e.height),{width:x+h+c+r,height:a+s+l+d}}layout(t,e,i=0,o=0){const n=this.calculateBoxSize(t);if(t.computedWidth=Math.min(n.width,e),t.computedHeight=n.height,t.x=i,t.y=o,t.children&&t.children.length>0){let e=o;const n=t.box||{},h=n.padding||{},s=i+(h.left||0)+(n.border?.width||0),r=t.computedWidth-(h.left||0)-(h.right||0)-2*(n.border?.width||0);for(const i of t.children)this.layout(i,r,s,e+(h.top||0)+(n.border?.width||0)),e+=i.computedHeight||0;const d=t.children.reduce(((t,e)=>t+(e.computedHeight||0)),0);t.computedHeight=d+(h.top||0)+(h.bottom||0)+2*(n.border?.width||0)}}renderText(t){if(!t.content||"text"!==t.type)return;const e=t.style||{},i=t.box||{},o=i.padding||{},n=i.border||{},h=e.fontSize||this.options.defaultFontSize,s=e.fontFamily||this.options.defaultFontFamily,r=e.fontWeight||"normal",d=e.color||"#000000",c=e.textAlign||"left";this.ctx.font=`${r} ${h}px ${s}`,this.ctx.fillStyle=d,this.ctx.textBaseline="top";const l=(t.x||0)+(o.left||0)+(n.width||0),x=(t.y||0)+(o.top||0)+(n.width||0),a=(t.computedWidth||0)-(o.left||0)-(o.right||0)-2*(n.width||0);let u=l;"center"===c?(u=l+a/2,this.ctx.textAlign="center"):"right"===c?(u=l+a,this.ctx.textAlign="right"):this.ctx.textAlign="left";const f=t.content.split(" "),p=[];let g="";for(const t of f){const e=g+(g?" ":"")+t;this.ctx.measureText(e).width>a&&g?(p.push(g),g=t):g=e}g&&p.push(g);const m=h*(e.lineHeight||this.options.defaultLineHeight);p.forEach(((t,i)=>{const o=x+i*m;if(this.ctx.fillText(t,u,o),"underline"===e.textDecoration){const e=this.ctx.measureText(t).width,i=o+h;this.ctx.beginPath(),this.ctx.moveTo("center"===c?u-e/2:u,i),this.ctx.lineTo("center"===c?u+e/2:u+e,i),this.ctx.strokeStyle=d,this.ctx.lineWidth=1,this.ctx.stroke()}}))}renderBox(t){const e=(t.box||{}).border||{};e.width&&e.width>0&&(this.ctx.strokeStyle=e.color||"#000000",this.ctx.lineWidth=e.width,"dashed"===e.style?this.ctx.setLineDash([5,5]):"dotted"===e.style?this.ctx.setLineDash([2,2]):this.ctx.setLineDash([]),this.ctx.strokeRect((t.x||0)+e.width/2,(t.y||0)+e.width/2,(t.computedWidth||0)-e.width,(t.computedHeight||0)-e.width))}renderNode(t){if(this.renderBox(t),"text"===t.type&&this.renderText(t),t.children)for(const e of t.children)this.renderNode(e)}render(t){this.ctx.clearRect(0,0,this.options.containerWidth,this.options.containerHeight),this.layout(t,this.options.containerWidth),this.renderNode(t)}getNodeAt(t,e,i){if(!(i.x&&i.y&&i.computedWidth&&i.computedHeight))return null;if(t>=i.x&&t<=i.x+i.computedWidth&&e>=i.y&&e<=i.y+i.computedHeight){if(i.children)for(const o of i.children){const i=this.getNodeAt(t,e,o);if(i)return i}return i}return null}}function e(t,e,i){return{type:"text",content:t,style:e,box:i}}function i(t,e){return{type:"container",children:t,box:e}}export{t as CanvasLayoutEngine,i as createContainerNode,e as createTextNode,t as default};
//# sourceMappingURL=index.js.map
