class e{caches=[];point=0;getImage(){let e=null;return this.point>0&&(this.point--,e=this.caches.shift()),e}getCaches(){return this.caches}push(e){this.caches.push(e)}tidy(){this.caches=Array.from(new Set(this.caches)),this.point=this.caches.length}cleanup(){this.caches.length=0,this.point=0}}const t=()=>{};const n=async(e,t=[],r=0)=>{try{return e()}catch(o){if(r>=t.length)throw o;return s=()=>n(e,t,++r),a=t[r],new Promise((e=>setTimeout((()=>e(s())),a)))}var s,a},r=4096,s=new Uint16Array(r);function a(e,t,n){if(t<0||n>e.length)throw new RangeError("Index out of range");if(n-t<1)return"";const a=[];let o=0;const i=e=>{a.push(String.fromCharCode.apply(null,Array.from(e)))};let l=!0;for(let r=t;r<n;r++)if(e[r]>127){l=!1;break}if(l){for(let a=t;a<n;a+=r){const t=Math.min(a+r,n)-a;for(let n=0;n<t;n++)s[n]=e[a+n];i(s.subarray(0,t))}return a.join("")}for(let a=t;a<n;){const t=e[a++];if(t<128){s[o++]=t,o===r&&(i(s),o=0);continue}let l;if(o>0&&(i(s.subarray(0,o)),o=0),192==(224&t)&&a<n)l=(31&t)<<6|63&e[a++];else if(224==(240&t)&&a+1<n)l=(15&t)<<12|(63&e[a++])<<6|63&e[a++];else if(240==(248&t)&&a+2<n){if(l=(7&t)<<18|(63&e[a++])<<12|(63&e[a++])<<6|63&e[a++],l>65535){l-=65536,s[o++]=55296+(l>>10),s[o++]=56320+(1023&l),o>=4094&&(i(s.subarray(0,o)),o=0);continue}}else for(l=65533;a<n&&128==(192&e[a]);)a++;s[o++]=l,o>=4093&&(i(s.subarray(0,o)),o=0)}return o>0&&i(s.subarray(0,o)),a.join("")}class o{plugins=[];platformVersion="0.0.1";version="";globals={env:"unknown",br:null,dpr:1};noop=t;retry=n;constructor(e,t){this.version=t||"",this.plugins=e,this.globals.env=this.autoEnv()}init(){this.globals.br=this.useBridge(),this.globals.dpr=this.usePixelRatio();const e=this.plugins.reduce(((e,t)=>(e[t.name]=t,e)),{}),t=this.plugins.map((e=>e.name));this.usePlugins(e,t,{})}autoEnv(){if("undefined"!=typeof window)return"h5";if("undefined"!=typeof tt)return"tt";if("undefined"!=typeof my)return"alipay";if("undefined"!=typeof wx)return"weapp";throw new Error("Unsupported app")}useBridge(){switch(this.globals.env){case"h5":return globalThis;case"alipay":return my;case"tt":return tt;case"weapp":return wx}return{}}usePixelRatio(){const{env:e,br:t}=this.globals;return"h5"===e?devicePixelRatio:"getWindowInfo"in t?t.getWindowInfo().pixelRatio:"getSystemInfoSync"in t?t.getSystemInfoSync().pixelRatio:1}usePlugins(e,t,n){t.forEach((t=>{const r=e[t];if(!n[t]){if(void 0===r)throw new Error(`Plugin ${t} not found`);if(Array.isArray(r.dependencies)){for(const n of r.dependencies)if("function"!=typeof e[n]?.install)throw new Error(`Plugin ${t} depends on plugin ${n}, but ${n} is not found`);this.usePlugins(e,r.dependencies,n)}this.installPlugin(r),n[r.name]=!0}}))}switch(e){this.globals.env=e,this.init()}}const i=e=>e;var l={name:"getCanvas",install(){const{retry:e}=this,{env:t,br:n,dpr:r}=this.globals,s=[50,100,100];function a(e,n,s){if(!e)throw new Error("canvas not found.");const a=1365,o=e.getContext("2d");let i=n*r,l=s*r;return"weapp"===t&&(i>a||l>a)&&(i>l?(l=l/i*a,i=a):(i=i/l*a,l=a)),e.width=i,e.height=l,{canvas:e,context:o}}if("h5"===t){const t=e=>document.querySelector(e);return n=>e((()=>{const e=t(`canvas[canvas-id=${n.slice(1)}]`)||t(n);return a(e,e?.clientWidth,e?.clientHeight)}),s)}return(t,r)=>e((()=>new Promise(((e,s)=>{let o=n.createSelectorQuery();r&&(o=o.in(r)),o.select(t).fields({node:!0,size:!0},(t=>{const{node:n,width:r,height:o}=t||{};try{e(a(n,r,o))}catch(e){s(e)}})).exec()}))),s)}},c={name:"decode",install(){const{env:e,br:t}=this.globals,n=(e,t="image/png")=>`data:${t};base64,${e}`,r={toBuffer(e){const{buffer:t,byteOffset:n,byteLength:r}=e;return t.slice(n,n+r)},bytesToString(e){let t="";for(let n=0;n<e.length;n+=8192){const r=e.slice(n,n+8192);t+=String.fromCharCode.apply(null,Array.from(r))}return t}};if("h5"===e){const e=new TextDecoder("utf-8",{fatal:!0});r.toDataURL=e=>n(btoa(r.bytesToString(e))),r.utf8=(t,n,r)=>e.decode(t.subarray(n,r))}else r.toDataURL=e=>n(t.arrayBufferToBase64(r.toBuffer(e))),r.utf8=a;return r}},u={name:"remote",install(){const{env:e,br:t}=this.globals,n=e=>/^(blob:)?http(s)?:\/\//.test(e);if("h5"===e)return{is:n,fetch:e=>fetch(e).then((e=>{if(e.ok)return e.arrayBuffer();throw new Error(`HTTP error, status=${e.status}, statusText=${e.statusText}`)}))};function r(e,n){return new Promise(((r,s)=>{t.request({url:e,dataType:"arraybuffer",responseType:"arraybuffer",enableCache:n,success:e=>r(e.data),fail:s})})).catch((t=>{const n=t.errMsg||t.errorMessage||t.message;if(n.includes("ERR_CACHE_WRITE_FAILURE")||n.includes("ERR_CACHE_WRITE_FAILED"))return r(e,!1);throw t}))}return{is:n,fetch:e=>r(e,!0)}}},f={name:"local",install(){const{env:e,br:t}=this.globals;if("h5"===e)return null;const n=t.getFileSystemManager();return{write:(e,t)=>new Promise(((r,s)=>{n.writeFile({filePath:t,data:e,success:()=>r(t),fail:s})})),read:e=>new Promise(((t,r)=>{n.readFile({filePath:e,success:e=>t(e.data),fail:r})})),remove:e=>new Promise(((t,r)=>{n.unlink({filePath:e,success:()=>t(e),fail:r})}))}}},h={name:"image",dependencies:["local","path","decode"],install(){const{local:e,path:t,decode:n,noop:r}=this,{env:s}=this.globals;function a(e,t){return new Promise(((n,r)=>{e.onload=()=>n(e),e.onerror=()=>r(new Error(`SVGA LOADING FAILURE: ${e.src}`)),e.src=t}))}if("h5"===s){const e=e=>"string"==typeof e?e:n.toDataURL(e);return{load:(t,r,s,o)=>r instanceof Uint8Array&&"createImageBitmap"in globalThis?createImageBitmap(new Blob([n.toBuffer(r)])).then((e=>(o.push(e),e))):r instanceof ImageBitmap?(o.push(r),Promise.resolve(r)):a(new Image,e(r)),release:e=>{const t=e.getCaches();for(const e of t)e.close();e.cleanup()}}}return{load:async(t,r,o,i)=>{const l=await(async(t,r)=>"string"==typeof t?t:"tt"===s||"alipay"===s?n.toDataURL(t):e.write(n.toBuffer(t),r).catch((e=>(console.warn(`image write fail: ${e.errorMessage||e.errMsg||e.message}`),n.toDataURL(t)))))(r,o),c=i.getImage()||t.createImage();return i.push(c),a(c,l)},release:n=>{const a=n.getCaches();for(const n of a)n.src.includes(t.USER_DATA_PATH)&&e.remove(n.src).catch(r),n.onload=null,n.onerror=null,n.src="";"alipay"===s?n.cleanup():n.tidy()}}}},g={name:"now",install(){const{env:e,br:t}=this.globals,n="h5"===e?performance:"tt"===e?t.performance:t.getPerformance();return"function"==typeof n?.now?n.now()-Date.now()>0?()=>n.now()/1e3:()=>n.now():()=>Date.now()}},p={name:"getOfsCanvas",install(){const{env:e}=this.globals;let t;return t="h5"===e?e=>new OffscreenCanvas(e.width,e.height):"alipay"===e?e=>my.createOffscreenCanvas(e):"tt"===e?e=>{const t=tt.createOffscreenCanvas();return t.width=e.width,t.height=e.height,t}:e=>wx.createOffscreenCanvas(e),e=>{const n=e.type||"2d",r=t({...e,type:n}),s=r.getContext(n);return{canvas:r,context:s}}}},d={name:"path",install(){const{env:e,br:t}=this.globals,n=e=>e.substring(e.lastIndexOf("/")+1);if("h5"===e)return{USER_DATA_PATH:"",filename:n,resolve:(e,t)=>""};const{USER_DATA_PATH:r}="tt"===e?tt.getEnvInfoSync().common:t.env;return{USER_DATA_PATH:r,filename:n,resolve:(e,t)=>`${r}/${t?`${t}.`:""}${e}`}}},m={name:"rAF",dependencies:["now"],install(){const{env:e}=this.globals;function t(){return e=>setTimeout(e,Math.max(0,16-Date.now()%16))}if("h5"===e){const e="requestAnimationFrame"in globalThis?requestAnimationFrame:t();return(t,n)=>e(n)}return(e,n)=>{try{return e.requestAnimationFrame(n)}catch(e){return console.warn(e.message),t()(n)}}}};export{e as ImageCaches,o as Platform,i as definePlugin,l as pluginCanvas,c as pluginDecode,u as pluginDownload,f as pluginFsm,h as pluginImage,g as pluginNow,p as pluginOfsCanvas,d as pluginPath,m as pluginRAF};
//# sourceMappingURL=index.js.map
