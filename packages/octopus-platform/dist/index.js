const e=()=>{};async function t(e,n=[],r=0){try{return await e()}catch(a){if(r>=n.length)throw a;return new Promise((a=>{setTimeout((()=>a(t(e,n,r+1))),n[r])}))}}function n(e,t,n){if(t<0||n>e.length)throw new RangeError("Index out of range");if(n-t<1)return"";const r=[],a=new Array(1024),{fromCharCode:s}=String;let i=0;for(let o=t;o<n;){const t=e[o++];if(t<=127)a[i++]=t,(1024===i||o<n&&e[o]>127)&&(r.push(s(...a.slice(0,i))),i=0);else{let l;if(i>0&&(r.push(s(...a.slice(0,i))),i=0),t>=192&&t<224&&o<n)l=(31&t)<<6|63&e[o++];else if(t>=224&&t<240&&o+1<n)l=(15&t)<<12|(63&e[o++])<<6|63&e[o++];else{if(t>=240&&t<248&&o+2<n){l=((7&t)<<18|(63&e[o++])<<12|(63&e[o++])<<6|63&e[o++])-65536,r.push(s(55296+(l>>10),56320+(1023&l)));continue}for(l=65533;o<n&&128==(192&e[o]);)o++}r.push(s(l))}}return i>0&&r.push(s(...a.slice(0,i))),r.join("")}class r{plugins=[];platformVersion="0.0.1";version="";global={env:"unknown",br:null,dpr:1};noop=e;retry=t;constructor(e,t){this.version=t||"",this.plugins=e,this.global.env=this.autoEnv(),this.init()}init(){this.global.br=this.useBridge(),this.global.dpr=this.usePixelRatio();const e=this.plugins.reduce(((e,t)=>(e[t.name]=t,e)),{}),t=this.plugins.map((e=>e.name));this.usePlugins(e,t,{})}autoEnv(){if("undefined"!=typeof window)return"h5";if("undefined"!=typeof tt)return"tt";if("undefined"!=typeof my)return"alipay";if("undefined"!=typeof wx)return"weapp";throw new Error("Unsupported app")}useBridge(){switch(this.global.env){case"h5":return globalThis;case"alipay":return my;case"tt":return tt;case"weapp":return wx}return{}}usePixelRatio(){const{env:e,br:t}=this.global;return"h5"===e?globalThis.devicePixelRatio:"getWindowInfo"in t?t.getWindowInfo().pixelRatio:"getSystemInfoSync"in t?t.getSystemInfoSync().pixelRatio:1}usePlugins(e,t,n){t.forEach((t=>{const r=e[t];if(n[t])return;if(void 0===r)throw new Error(`Plugin ${t} not found`);Array.isArray(r.dependencies)&&this.usePlugins(e,r.dependencies,n);const a=r.install.call(this);n[r.name]=!0,console.log(`Plugin ${t} installed`,this,r.name,a),void 0!==a&&Reflect.set(this.constructor.prototype,r.name,a)}))}switch(e){this.global.env=e,this.init()}}const a=e=>e;var s={name:"getCanvas",install(){const{retry:e}=this,{env:t,br:n,dpr:r}=this.global;function a(e,n,a){if(!e)throw new Error("canvas not found.");const s=1365,i=e.getContext("2d");let o=n*r,l=a*r;return"weapp"===t&&(o>s||l>s)&&(o>l?(l=l/o*s,o=s):(o=o/l*s,l=s)),e.width=o,e.height=l,{canvas:e,context:i}}if("h5"===t){const t=e=>document.querySelector(e);return n=>e((()=>{const e=t(`canvas[canvas-id=${n.slice(1)}]`)||t(n);return a(e,e?.clientWidth,e?.clientHeight)}),[50,100,100])}return(t,r)=>e((()=>new Promise(((e,s)=>{let i=n.createSelectorQuery();r&&(i=i.in(r)),i.select(t).fields({node:!0,size:!0},(t=>{const{node:n,width:r,height:i}=t||{};try{e(a(n,r,i))}catch(e){s(e)}})).exec()}))))}},i={name:"decode",install(){const{env:e,br:t}=this.global,r=e=>`data:image/png;base64,${e}`,a={toBuffer(e){const{buffer:t,byteOffset:n,byteLength:r}=e;return t.slice(n,n+r)}};if("h5"===e){const e=new TextDecoder;a.toBitmap=e=>globalThis.createImageBitmap(new Blob([a.toBuffer(e)])),a.toDataURL=e=>r(globalThis.btoa(String.fromCharCode(...e))),a.utf8=(t,n,r)=>e.decode(t.subarray(n,r))}else a.toDataURL=e=>r(t.arrayBufferToBase64(a.toBuffer(e))),a.utf8=n;return a}},o={name:"remote",install(){const{env:e,br:t}=this.global,n=e=>/^http(s)?:\/\//.test(e);if("h5"===e)return{is:n,fetch:e=>fetch(e).then((e=>{if(e.ok)return e.arrayBuffer();throw new Error(`HTTP error, status=${e.status}, statusText=${e.statusText}`)}))};function r(e,n){return new Promise(((r,a)=>{t.request({url:e,dataType:"arraybuffer",responseType:"arraybuffer",enableCache:n,success:e=>r(e.data),fail:a})})).catch((t=>{const n=t.errMsg||t.errorMessage||t.message;if(n.includes("ERR_CACHE_WRITE_FAILURE")||n.includes("ERR_CACHE_WRITE_FAILED"))return r(e,!1);throw t}))}return{is:n,fetch:e=>r(e,!0)}}},l={name:"local",install(){const{env:e,br:t}=this.global;if("h5"===e)return null;const n=t.getFileSystemManager();return{write:(e,t)=>new Promise(((r,a)=>{n.writeFile({filePath:t,data:e,success:()=>r(t),fail:e=>a(e)})})),read:e=>new Promise(((t,r)=>{n.readFile({filePath:e,success:e=>t(e.data),fail:e=>r(e)})})),remove:e=>new Promise((t=>{n.unlink({filePath:e,success:()=>t(e),fail:n=>t(e)})}))}}},c={name:"image",install(){const{local:e,path:t,decode:n,noop:r}=this,{env:a}=this.global,s=new Set;function i(t,n){return new Promise(((a,i)=>{t.onload=()=>{a(t),s.has(n)&&e.remove(n).catch(r).then((()=>s.delete(n)))},t.onerror=()=>i(new Error(`SVGA LOADING FAILURE: ${t.src}`)),t.src=n}))}if("h5"===a){const e=e=>new Image,t=e=>"string"==typeof e?e:n.toDataURL(e);return{isImage:e=>e instanceof Image,isImageBitmap:e=>e instanceof ImageBitmap,create:e,load:(r,a,s,o)=>a instanceof Uint8Array&&"createImageBitmap"in globalThis?n.toBitmap(a):a instanceof ImageBitmap?Promise.resolve(a):i(e(),t(a))}}const o=e=>e.createImage();return{isImage:e=>!(!e||void 0===e.src||void 0===e.width||void 0===e.height),isImageBitmap:e=>!1,create:o,load:async(r,l,c,u)=>{const h=await(async(r,i,o)=>{if("string"==typeof r)return r;if("tt"===a||"alipay"===a)return n.toDataURL(r);try{const a=t.resolve(i,o);return await e.write(n.toBuffer(r),a),s.add(a),a}catch(e){return console.warn(`图片缓存失败：${e.message}`),n.toDataURL(r)}})(l,c,u);return i(o(r),h)}}}},u={name:"now",install(){const{env:e,br:t}=this.global,n="h5"===e?globalThis.performance:"tt"===e?t.performance:t.getPerformance();return"function"==typeof n?.now?n.now()-Date.now()>0?()=>n.now()/1e3:()=>n.now():()=>Date.now()}},h={name:"getOfsCanvas",install(){const{env:e}=this.global;let t;return t="h5"===e?e=>new OffscreenCanvas(e.width,e.height):"alipay"===e?e=>my.createOffscreenCanvas({width:e.width,height:e.height}):"tt"===e?e=>{const t=tt.createOffscreenCanvas();return t.width=e.width,t.height=e.height,t}:e=>wx.createOffscreenCanvas({...e,type:"2d"}),e=>{const n=t(e),r=n.getContext("2d");return{canvas:n,context:r}}}},f={name:"path",install(){const{env:e,br:t}=this.global,n=e=>e.substring(e.lastIndexOf("/")+1);if("h5"===e)return{USER_DATA_PATH:"",filename:n,resolve:(e,t)=>""};const{USER_DATA_PATH:r}="tt"===e?tt.getEnvInfoSync().common:t.env;return{USER_DATA_PATH:r,filename:n,resolve:(e,t)=>`${r}/${t?`${t}.`:""}${e}`}}},g={name:"rAF",install(){const{env:e}=this.global;return"h5"===e?(e,t)=>globalThis.requestAnimationFrame(t):(e,t)=>e.requestAnimationFrame(t)}};export{r as OctopusPlatform,a as definePlugin,e as noop,s as pluginCanvas,i as pluginDecode,o as pluginDownload,l as pluginFsm,c as pluginImage,u as pluginNow,h as pluginOfsCanvas,f as pluginPath,g as pluginRAF,t as retry,n as utf8};
//# sourceMappingURL=index.js.map
