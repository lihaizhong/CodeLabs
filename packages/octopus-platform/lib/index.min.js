!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((n="undefined"!=typeof globalThis?globalThis:n||self).OctopusPlatform={})}(this,(function(n){"use strict";var e=function(){},t=function(){return t=Object.assign||function(n){for(var e,t=1,r=arguments.length;t<r;t++)for(var i in e=arguments[t])Object.prototype.hasOwnProperty.call(e,i)&&(n[i]=e[i]);return n},t.apply(this,arguments)};function r(n,e,t,r){return new(t||(t=Promise))((function(i,o){function a(n){try{s(r.next(n))}catch(n){o(n)}}function u(n){try{s(r.throw(n))}catch(n){o(n)}}function s(n){var e;n.done?i(n.value):(e=n.value,e instanceof t?e:new t((function(n){n(e)}))).then(a,u)}s((r=r.apply(n,e||[])).next())}))}function i(n,e){var t,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=u(0),a.throw=u(1),a.return=u(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(u){return function(s){return function(u){if(t)throw new TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(o=0)),o;)try{if(t=1,r&&(i=2&u[0]?r.return:u[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,u[1])).done)return i;switch(r=0,i&&(u=[2&u[0],i.value]),u[0]){case 0:case 1:i=u;break;case 4:return o.label++,{value:u[1],done:!1};case 5:o.label++,r=u[1],u=[0];continue;case 7:u=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==u[0]&&2!==u[0])){o=0;continue}if(3===u[0]&&(!i||u[1]>i[0]&&u[1]<i[3])){o.label=u[1];break}if(6===u[0]&&o.label<i[1]){o.label=i[1],i=u;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(u);break}i[2]&&o.ops.pop(),o.trys.pop();continue}u=e.call(n,o)}catch(n){u=[6,n],r=0}finally{t=i=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,s])}}}function o(n){return r(this,arguments,void 0,(function(n,e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),i(this,(function(r){try{return[2,n()]}catch(r){if(t>=e.length)throw r;return[2,(i=function(){return o(n,e,++t)},a=e[t],new Promise((function(n){return setTimeout((function(){return n(i())}),a)})))]}var i,a;return[2]}))}))}"function"==typeof SuppressedError&&SuppressedError;var a=4096,u=new Uint16Array(a);function s(n,e,t){if(e<0||t>n.length)throw new RangeError("Index out of range");if(t-e<1)return"";for(var r=[],i=0,o=function(n){r.push(String.fromCharCode.apply(null,Array.from(n)))},s=!0,c=e;c<t;c++)if(n[c]>127){s=!1;break}if(s){for(c=e;c<t;c+=a){for(var f=Math.min(c+a,t)-c,l=0;l<f;l++)u[l]=n[c+l];o(u.subarray(0,f))}return r.join("")}for(c=e;c<t;){var h=n[c++];if(h<128)u[i++]=h,i===a&&(o(u),i=0);else{i>0&&(o(u.subarray(0,i)),i=0);var p=void 0;if(192==(224&h)&&c<t)p=(31&h)<<6|63&n[c++];else if(224==(240&h)&&c+1<t)p=(15&h)<<12|(63&n[c++])<<6|63&n[c++];else if(240==(248&h)&&c+2<t){if((p=(7&h)<<18|(63&n[c++])<<12|(63&n[c++])<<6|63&n[c++])>65535){p-=65536,u[i++]=55296+(p>>10),u[i++]=56320+(1023&p),i>=4094&&(o(u.subarray(0,i)),i=0);continue}}else for(p=65533;c<t&&128==(192&n[c]);)c++;u[i++]=p,i>=4093&&(o(u.subarray(0,i)),i=0)}}return i>0&&o(u.subarray(0,i)),r.join("")}var c=function(){function n(n,t){this.plugins=[],this.platformVersion="0.0.2",this.version="",this.globals={env:"unknown",br:null,dpr:1,system:"unknown"},this.noop=e,this.retry=o,this.version=t||"",this.plugins=n,this.globals.env=this.autoEnv()}return n.prototype.init=function(){var n=this.globals,e=this.plugins,t=new Map,r=[],i=new Set;n.br=this.useBridge(),n.dpr=this.usePixelRatio(),n.system=this.useSystem();for(var o=0,a=e;o<a.length;o++){var u=a[o];r.push(u.name),t.set(u.name,u)}this.usePlugins(t,r,i),i.clear()},n.prototype.autoEnv=function(){if("undefined"!=typeof window)return"h5";if("undefined"!=typeof tt)return"tt";if("undefined"!=typeof my)return"alipay";if("undefined"!=typeof wx)return"weapp";throw new Error("Unsupported app")},n.prototype.useBridge=function(){switch(this.globals.env){case"h5":return globalThis;case"alipay":return my;case"tt":return tt;case"weapp":return wx}return{}},n.prototype.usePixelRatio=function(){var n=this.globals,e=n.env,t=n.br;return"h5"===e?devicePixelRatio:"getWindowInfo"in t?t.getWindowInfo().pixelRatio:"getSystemInfoSync"in t?t.getSystemInfoSync().pixelRatio:1},n.prototype.useSystem=function(){var n;switch(this.globals.env){case"weapp":n=wx.getDeviceInfo().platform;break;case"alipay":n=my.getDeviceBaseInfo().platform;break;case"tt":n=tt.getDeviceInfoSync().platform;break;default:n="unknown"}return n.toLowerCase()},n.prototype.usePlugins=function(n,e,t){for(var r,i=0,o=e;i<o.length;i++){var a=o[i];if(!n.has(a))throw new Error("Plugin ".concat(a," not found"));if(t.has(a))return;var u=n.get(a);if(Array.isArray(u.dependencies)){for(var s=0,c=u.dependencies;s<c.length;s++){var f=c[s];if("function"!=typeof(null===(r=n.get(f))||void 0===r?void 0:r.install))throw new Error("Plugin ".concat(a," depends on plugin ").concat(f,", but ").concat(f," is not found"))}this.usePlugins(n,u.dependencies,t)}this.installPlugin(u),t.add(a)}},n.prototype.switch=function(n){this.globals.env=n,this.init()},n}(),f=function(n){return n};var l={name:"getSelector",install:function(){var n=this.globals,e=n.env,t=n.br;return"h5"===e?function(n){return document.querySelector(n)}:function(n,e){var r=t.createSelectorQuery();return e&&(r=r.in(e)),r.select(n).fields({node:!0,size:!0})}}},h={name:"getCanvas",dependencies:["getSelector"],install:function(){var n=this.retry,e=this.getSelector,t=this.globals,r=t.env;t.br;var i=t.dpr,o=[50,100,100];function a(n,e,t){if(!n)throw new Error("canvas not found.");var r=n.getContext("2d");return n.width=e*i,n.height=t*i,{canvas:n,context:r}}return"h5"===r?function(t){return n((function(){var n=e("canvas[canvas-id=".concat(t.slice(1),"]"))||e(t);return a(n,null==n?void 0:n.clientWidth,null==n?void 0:n.clientHeight)}),o)}:function(t,r){return n((function(){return new Promise((function(n,i){e(t,r).exec((function(e){var t=e[0]||{},r=t.node,o=t.width,u=t.height;try{n(a(r,o,u))}catch(n){i(n)}}))}))}),o)}}},p={name:"decode",install:function(){var n=this.globals,e=n.env,r=n.br,i=function(n,e){return void 0===e&&(e="image/png"),"data:".concat(e,";base64,").concat(n)},o={toBuffer:function(n){var e=n.buffer,t=n.byteOffset,r=n.byteLength;if(e instanceof ArrayBuffer)return e.slice(t,t+r);var i=new Uint8Array(r);return i.set(n),i.buffer},bytesToString:function(n){for(var e="",t=0;t<n.length;t+=8192){var r=n.slice(t,t+8192);e+=String.fromCharCode.apply(null,Array.from(r))}return e}};if("h5"===e){var a=new TextDecoder("utf-8",{fatal:!0});return t(t({},o),{toDataURL:function(n){return i(btoa(o.bytesToString(n)))},utf8:function(n,e,t){return a.decode(n.subarray(e,t))}})}return t(t({},o),{toDataURL:function(n){return i(r.arrayBufferToBase64(o.toBuffer(n)))},utf8:s})}},v={name:"remote",install:function(){var n=this.globals,e=n.env,t=n.br,r=function(n){return/^(blob:)?http(s)?:\/\//.test(n)};if("h5"===e)return{is:r,fetch:function(n){return fetch(n).then((function(n){if(n.ok)return n.arrayBuffer();throw new Error("HTTP error, status=".concat(n.status,", statusText=").concat(n.statusText))}))}};function i(n,e){return new Promise((function(r,i){t.request({url:n,dataType:"arraybuffer",responseType:"arraybuffer",enableCache:e,success:function(n){return r(n.data)},fail:i})})).catch((function(e){var t=e.errMsg||e.errorMessage||e.message;if(t.includes("ERR_CACHE_WRITE_FAILURE")||t.includes("ERR_CACHE_WRITE_FAILED"))return i(n,!1);throw e}))}return{is:r,fetch:function(n){return i(n,!0)}}}},d={name:"local",install:function(){var n=this.globals,e=n.env,t=n.br;if("h5"===e||"tt"===e)return null;var r=t.getFileSystemManager();return{exists:function(n){return new Promise((function(e){r.access({path:n,success:function(){return e(!0)},fail:function(){return e(!1)}})}))},write:function(n,e){return new Promise((function(t,i){r.writeFile({filePath:e,data:n,success:function(){return t(e)},fail:i})}))},read:function(n){return new Promise((function(e,t){r.readFile({filePath:n,success:function(n){return e(n.data)},fail:t})}))},remove:function(n){return new Promise((function(e,t){r.unlink({filePath:n,success:function(){return e(n)},fail:t})}))}}}},g={name:"image",dependencies:["local","decode"],install:function(){var n=this,e=this.local,t=this.decode,o=this.globals.env,a=function(n,e){return"string"==typeof n?n:t.toDataURL(n)};function u(n,e){return new Promise((function(t,r){n.onload=function(){return t(n)},n.onerror=function(){return r(new Error("SVGA LOADING FAILURE: ".concat(e)))},n.src=e}))}function s(n){n.onload=null,n.onerror=null,n.src=""}return"h5"===o?{create:function(n){return new Image},load:function(n,e,r){return e instanceof Uint8Array&&"createImageBitmap"in globalThis?createImageBitmap(new Blob([t.toBuffer(e)])):e instanceof ImageBitmap?Promise.resolve(e):u(n(),a(e,r))},release:s}:("weapp"===o&&(a=function(o,a){return r(n,void 0,void 0,(function(){return i(this,(function(n){return"string"==typeof o?[2,o]:[2,e.write(t.toBuffer(o),a).catch((function(n){return console.warn("image write fail: ".concat(n.errorMessage||n.errMsg||n.message)),t.toDataURL(o)}))]}))}))}),{create:function(n){return n.createImage()},load:function(e,t,o){return r(n,void 0,void 0,(function(){var n,r;return i(this,(function(i){switch(i.label){case 0:return n=u,r=[e()],[4,a(t,o)];case 1:return[2,n.apply(void 0,r.concat([i.sent()]))]}}))}))},release:s})}},y={name:"intersectionObserver",dependencies:["getSelector"],install:function(){var n=this.getSelector,e=this.globals,t=e.env,r=e.br,i=[0,.5,1];return"h5"===t?function(e,t){var r=new IntersectionObserver((function(n){t(n[0].intersectionRatio>0)}),{threshold:i}),o=n(e);return o&&r.observe(o),function(){r.disconnect()}}:function(n,e,t){var o=r.createIntersectionObserver(t,{thresholds:i,initialRatio:0});return o.observe(n,(function(n){e(n.intersectionRatio>0)})),function(){o.disconnect()}}}},b={name:"now",install:function(){var n=this.globals,e=n.env,t=n.br,r="h5"===e||"tt"===e?performance:t.getPerformance();return"function"==typeof(null==r?void 0:r.now)?r.now()-Date.now()>1?function(){return r.now()/1e3}:function(){return r.now()}:function(){return Date.now()}}},w={name:"getOfsCanvas",install:function(){var n,e=this.globals.env;return n="h5"===e?function(n){return new OffscreenCanvas(n.width,n.height)}:"alipay"===e?function(n){return my.createOffscreenCanvas(n)}:"tt"===e?function(n){var e=tt.createOffscreenCanvas();return e.width=n.width,e.height=n.height,e}:function(n){return wx.createOffscreenCanvas(n)},function(e){var r=e.type||"2d",i=n(t(t({},e),{type:r})),o=i.getContext(r);return{canvas:i,context:o}}}},m={name:"path",install:function(){var n=this.globals,e=n.env,t=n.br,r=function(n){var e=n.split(/\?#/g)[0];return e.substring(e.lastIndexOf("/")+1)};if("h5"===e||"tt"===e)return{USER_DATA_PATH:"",is:function(n){return!1},filename:r,resolve:function(n,e){return""}};var i=t.env.USER_DATA_PATH;return{USER_DATA_PATH:i,is:function(n){return null==n?void 0:n.startsWith(i)},filename:r,resolve:function(n,e){return"".concat(i,"/").concat(e?"".concat(e,"__"):"").concat(n)}}}},P={name:"rAF",install:function(){function n(){return function(n){return setTimeout(n,Math.max(0,16-Date.now()%16))}}if("h5"===this.globals.env){var e="requestAnimationFrame"in globalThis?requestAnimationFrame:n();return function(n,t){return e(t)}}return function(e,t){try{return e.requestAnimationFrame(t)}catch(e){return console.warn(e.message),n()(t)}}}};n.OctopusPlatform=c,n.definePlugin=f,n.installPlugin=function(n,e){var t=e.install.call(n);Object.defineProperty(n,e.name,{get:function(){return t},enumerable:!0,configurable:!0})},n.pluginCanvas=h,n.pluginDecode=p,n.pluginDownload=v,n.pluginFsm=d,n.pluginImage=g,n.pluginIntersectionObserver=y,n.pluginNow=b,n.pluginOfsCanvas=w,n.pluginPath=m,n.pluginRAF=P,n.pluginSelector=l,Object.defineProperty(n,"__esModule",{value:!0})}));//# sourceMappingURL=index.min.js.map
