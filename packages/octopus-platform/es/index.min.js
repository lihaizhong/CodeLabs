const e=()=>{};async function t(e,n=[],r=0){try{return e()}catch(o){if(r>=n.length)throw o;return s=()=>t(e,n,++r),a=n[r],new Promise((e=>setTimeout((()=>e(s())),a)))}var s,a}const n=4096,r=new Uint16Array(n);function s(e,t,s){if(t<0||s>e.length)throw new RangeError("Index out of range");if(s-t<1)return"";const a=[];let o=0;const i=e=>{a.push(String.fromCharCode.apply(null,Array.from(e)))};let l=!0;for(let n=t;n<s;n++)if(e[n]>127){l=!1;break}if(l){for(let a=t;a<s;a+=n){const t=Math.min(a+n,s)-a;for(let n=0;n<t;n++)r[n]=e[a+n];i(r.subarray(0,t))}return a.join("")}for(let a=t;a<s;){const t=e[a++];if(t<128){r[o++]=t,o===n&&(i(r),o=0);continue}let l;if(o>0&&(i(r.subarray(0,o)),o=0),192==(224&t)&&a<s)l=(31&t)<<6|63&e[a++];else if(224==(240&t)&&a+1<s)l=(15&t)<<12|(63&e[a++])<<6|63&e[a++];else if(240==(248&t)&&a+2<s){if(l=(7&t)<<18|(63&e[a++])<<12|(63&e[a++])<<6|63&e[a++],l>65535){l-=65536,r[o++]=55296+(l>>10),r[o++]=56320+(1023&l),o>=4094&&(i(r.subarray(0,o)),o=0);continue}}else for(l=65533;a<s&&128==(192&e[a]);)a++;r[o++]=l,o>=4093&&(i(r.subarray(0,o)),o=0)}return o>0&&i(r.subarray(0,o)),a.join("")}class a{plugins=[];platformVersion="0.0.2";version="";globals={env:"unknown",br:null,dpr:1,system:"unknown"};noop=e;retry=t;constructor(e,t){this.version=t||"",this.plugins=e,this.globals.env=this.autoEnv()}init(){const{globals:e,plugins:t}=this,n=new Map,r=[],s=new Set;e.br=this.useBridge(),e.dpr=this.usePixelRatio(),e.system=this.useSystem();for(const e of t)r.push(e.name),n.set(e.name,e);this.usePlugins(n,r,s),s.clear()}autoEnv(){if("undefined"!=typeof window)return"h5";if("undefined"!=typeof tt)return"tt";if("undefined"!=typeof my)return"alipay";if("undefined"!=typeof wx)return"weapp";throw new Error("Unsupported app")}useBridge(){switch(this.globals.env){case"h5":return globalThis;case"alipay":return my;case"tt":return tt;case"weapp":return wx}return{}}usePixelRatio(){const{env:e,br:t}=this.globals;return"h5"===e?devicePixelRatio:"getWindowInfo"in t?t.getWindowInfo().pixelRatio:"getSystemInfoSync"in t?t.getSystemInfoSync().pixelRatio:1}useSystem(){const{env:e}=this.globals;let t;switch(e){case"weapp":t=wx.getDeviceInfo().platform;break;case"alipay":t=my.getDeviceBaseInfo().platform;break;case"tt":t=tt.getDeviceInfoSync().platform;break;default:t="unknown"}return t.toLowerCase()}usePlugins(e,t,n){for(const r of t){if(!e.has(r))throw new Error(`Plugin ${r} not found`);if(n.has(r))return;const t=e.get(r);if(Array.isArray(t.dependencies)){for(const n of t.dependencies)if("function"!=typeof e.get(n)?.install)throw new Error(`Plugin ${r} depends on plugin ${n}, but ${n} is not found`);this.usePlugins(e,t.dependencies,n)}this.installPlugin(t),n.add(r)}}switch(e){this.globals.env=e,this.init()}}const o=e=>e;function i(e,t){const n=t.install.call(e);Object.defineProperty(e,t.name,{get:()=>n,enumerable:!0,configurable:!0})}var l={name:"getSelector",install(){const{env:e,br:t}=this.globals;return"h5"===e?e=>document.querySelector(e):(e,n)=>{let r=t.createSelectorQuery();return n&&(r=r.in(n)),r.select(e).fields({node:!0,size:!0})}}},c={name:"getCanvas",dependencies:["getSelector"],install(){const{retry:e,getSelector:t}=this,{env:n,br:r,dpr:s}=this.globals,a=[50,100,100];function o(e,t,n){if(!e)throw new Error("canvas not found.");const r=e.getContext("2d");return e.width=t*s,e.height=n*s,{canvas:e,context:r}}return"h5"===n?n=>e((()=>{const e=t(`canvas[canvas-id=${n.slice(1)}]`)||t(n);return o(e,e?.clientWidth,e?.clientHeight)}),a):(n,r)=>e((()=>new Promise(((e,s)=>{t(n,r).exec((t=>{const{node:n,width:r,height:a}=t[0]||{};try{e(o(n,r,a))}catch(e){s(e)}}))}))),a)}},u={name:"decode",install(){const{env:e,br:t}=this.globals,n=(e,t="image/png")=>`data:${t};base64,${e}`,r={toBuffer(e){const{buffer:t,byteOffset:n,byteLength:r}=e;if(t instanceof ArrayBuffer)return t.slice(n,n+r);const s=new Uint8Array(r);return s.set(e),s.buffer},bytesToString(e){let t="";for(let n=0;n<e.length;n+=8192){const r=e.slice(n,n+8192);t+=String.fromCharCode.apply(null,Array.from(r))}return t}};if("h5"===e){const e=new TextDecoder("utf-8",{fatal:!0});return{...r,toDataURL:e=>n(btoa(r.bytesToString(e))),utf8:(t,n,r)=>e.decode(t.subarray(n,r))}}return{...r,toDataURL:e=>n(t.arrayBufferToBase64(r.toBuffer(e))),utf8:s}}},f={name:"remote",install(){const{env:e,br:t}=this.globals,n=e=>/^(blob:)?http(s)?:\/\//.test(e);if("h5"===e)return{is:n,fetch:e=>fetch(e).then((e=>{if(e.ok)return e.arrayBuffer();throw new Error(`HTTP error, status=${e.status}, statusText=${e.statusText}`)}))};function r(e,n){return new Promise(((r,s)=>{t.request({url:e,dataType:"arraybuffer",responseType:"arraybuffer",enableCache:n,success:e=>r(e.data),fail:s})})).catch((t=>{const n=t.errMsg||t.errorMessage||t.message;if(n.includes("ERR_CACHE_WRITE_FAILURE")||n.includes("ERR_CACHE_WRITE_FAILED"))return r(e,!1);throw t}))}return{is:n,fetch:e=>r(e,!0)}}},h={name:"local",install(){const{env:e,br:t}=this.globals;if("h5"===e||"tt"===e)return null;const n=t.getFileSystemManager();return{exists:e=>new Promise((t=>{n.access({path:e,success:()=>t(!0),fail:()=>t(!1)})})),write:(e,t)=>new Promise(((r,s)=>{n.writeFile({filePath:t,data:e,success:()=>r(t),fail:s})})),read:e=>new Promise(((t,r)=>{n.readFile({filePath:e,success:e=>t(e.data),fail:r})})),remove:e=>new Promise(((t,r)=>{n.unlink({filePath:e,success:()=>t(e),fail:r})}))}}},g={name:"image",dependencies:["local","decode"],install(){const{local:e,decode:t}=this,{env:n}=this.globals;let r=(e,n)=>"string"==typeof e?e:t.toDataURL(e);function s(e,t){return new Promise(((n,r)=>{e.onload=()=>n(e),e.onerror=()=>r(new Error(`SVGA LOADING FAILURE: ${t}`)),e.src=t}))}function a(e){e.onload=null,e.onerror=null,e.src=""}return"h5"===n?{create:e=>new Image,load:(e,n,a)=>n instanceof Uint8Array&&"createImageBitmap"in globalThis?createImageBitmap(new Blob([t.toBuffer(n)])):n instanceof ImageBitmap?Promise.resolve(n):s(e(),r(n,a)),release:a}:("weapp"===n&&(r=async(n,r)=>"string"==typeof n?n:e.write(t.toBuffer(n),r).catch((e=>(console.warn(`image write fail: ${e.errorMessage||e.errMsg||e.message}`),t.toDataURL(n))))),{create:e=>e.createImage(),load:async(e,t,n)=>s(e(),await r(t,n)),release:a})}},d={name:"intersectionObserver",dependencies:["getSelector"],install(){const{getSelector:e}=this,{env:t,br:n}=this.globals,r=[0,.5,1];return"h5"===t?(t,n)=>{const s=new IntersectionObserver((e=>{n(e[0].intersectionRatio>0)}),{threshold:r}),a=e(t);return a&&s.observe(a),()=>{s.disconnect()}}:(e,t,s)=>{const a=n.createIntersectionObserver(s,{thresholds:r,initialRatio:0});return a.observe(e,(e=>{t(e.intersectionRatio>0)})),()=>{a.disconnect()}}}},m={name:"now",install(){const{env:e,br:t}=this.globals,n="h5"===e||"tt"===e?performance:t.getPerformance();return"function"==typeof n?.now?n.now()-Date.now()>1?()=>n.now()/1e3:()=>n.now():()=>Date.now()}},w={name:"getOfsCanvas",install(){const{env:e}=this.globals;let t;return t="h5"===e?e=>new OffscreenCanvas(e.width,e.height):"alipay"===e?e=>my.createOffscreenCanvas(e):"tt"===e?e=>{const t=tt.createOffscreenCanvas();return t.width=e.width,t.height=e.height,t}:e=>wx.createOffscreenCanvas(e),e=>{const n=e.type||"2d",r=t({...e,type:n}),s=r.getContext(n);return{canvas:r,context:s}}}},p={name:"path",install(){const{env:e,br:t}=this.globals,n=e=>{const t=e.split(/\?#/g)[0];return t.substring(t.lastIndexOf("/")+1)};if("h5"===e||"tt"===e)return{USER_DATA_PATH:"",is:e=>!1,filename:n,resolve:(e,t)=>""};const{USER_DATA_PATH:r}=t.env;return{USER_DATA_PATH:r,is:e=>e?.startsWith(r),filename:n,resolve:(e,t)=>`${r}/${t?`${t}__`:""}${e}`}}},b={name:"rAF",install(){const{env:e}=this.globals;function t(){return e=>setTimeout(e,Math.max(0,16-Date.now()%16))}if("h5"===e){const e="requestAnimationFrame"in globalThis?requestAnimationFrame:t();return(t,n)=>e(n)}return(e,n)=>{try{return e.requestAnimationFrame(n)}catch(e){return console.warn(e.message),t()(n)}}}};export{a as OctopusPlatform,o as definePlugin,i as installPlugin,c as pluginCanvas,u as pluginDecode,f as pluginDownload,h as pluginFsm,g as pluginImage,d as pluginIntersectionObserver,m as pluginNow,w as pluginOfsCanvas,p as pluginPath,b as pluginRAF,l as pluginSelector};//# sourceMappingURL=index.min.js.map
